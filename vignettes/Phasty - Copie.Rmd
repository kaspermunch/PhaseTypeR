---
title: "Phasty v0.1"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Phasty}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, setup}
library(phasty)
```

# Informations

Please report any issues on the git page of the package ...

# Introduction

Phase-type distributions is an important mathematical tool especially in fields like insurance or population genetics.

The basic idea is considering a markov jump process (or a Markov chain for discrete cases) with $n$ transient states and 1 absorbing state (i.e. once in the absorbing state, it cannot go out), you can have the time before reaching that absorbing state using with the intensity matrix and the initial probabilities to start in each state. The matrix form of pahse-type distribution allow great simplification in some calculus, in particular to find the moments of the time before reaching the absorbing state.

The package `r phasty` handle this phase-type distribution and the calculation behind it.

This package is a complete as possible, nevertheless, it stays a package which bring mathematical tools and its not oriented for a specific application. 

The main references that have been used for this package are:

# The phase-type S3 class objects

The package use several new classes for describing a phase-type distributed object, which are: "disc_phase_type", "cont_phase
_type", "mult_disc_phase_type", "mult_cont_phase_type". Which can be obtain
using `r phase_type`, here is an example considering a univariate continuous phase_type distribution:

```{r}
subintensity_matrix <- matrix(c(-1.5, 0, 0,
                              1.5, -1, 0,
                              0, 1, -0.5), ncol = 3)
initial_probabilities <- c(0.9, 0.1, 0)
ph <- phase_type(subintensity_matrix, initial_probabilities)

print(ph)
```

With `r subint_mat` the subintensity matrix and `r init_probs` the vector of initials probabilities. 
An object of one of the phase_type class should have a subintensity matrix, a initial probability vector, a defect being the probability to start directly in 
the absorbing state, which can happens when using reward transformation (see section \)) and the type of class.

The init_probs are optional in the inputs, in that case the probability to start in the first state will be 1.

Those classes will be necessary later on to recognise the type of object for function like mean or var.

# The univariate distribution

## The continuous univariate phase-type

Let's consider a Markov jump process (MJP) with $n$ transient states and 1 absorbing states and define $\tau \sim PH(\boldsymbol{T}, \boldsymbol{\pi})$, where $\boldsymbol{T}$ is the subintensity matrix of the corresponding MJP and $\boldsymbol{\pi}$ is the vector of probabilities to start in state $i$.

$\tau$ will follow a continuous phase-type distribution which corresponds to the time before reaching the absorbing state.

In phasty, to define an object which follows a phase-type distribution, it requires to use the function `r phase_type`. This function will creates a S3 'cont_phase_type' object and requires the subintensity matrix and a vector of initial probabilities. This same function can also be used for discrete phase-type as it will be shown later.
Note that NULL is a valid argument for the initial probabilities, in that case the inital probabilities will be $\boldsymbol{\pi} = (1,\, 0,\, 0,\, ...)$.

```{r}
subintensity_matrix <- matrix(c(-1.5, 0, 0,
                              1.5, -1, 0,
                              0, 1, -0.5), ncol = 3)
initial_probabilities <- c(0.9, 0.1, 0)
ph <- phase_type(subintensity_matrix, initial_probabilities)

print(ph)
```

With this object we can now calculate the mean and variance of `r ph`
The mean from theorem 3.1.16 of Bladt and Nielsen, the mean of a variable following a continuous phase type is define by:

$$
\mathbb{E} (\tau) = \boldsymbol{\pi U e} = \boldsymbol{\pi} (-\boldsymbol{T})^{-1} \boldsymbol{e}
$$
 and from corollary 3.1.18 in Bladt and Nielsen, the $n^{th}$ moment of $\tau\sim PH(\boldsymbol{T}, \boldsymbol{\pi}) is defined by  

$$
\mathbb{E} (\tau^n) = n!\boldsymbol{\pi} (-\boldsymbol{T})^{-n} \boldsymbol{e}
$$
from this we can write the variance of $\tau$ as:

$$
\mathbb{E} (\tau^n) = (2\boldsymbol{\pi} (-\boldsymbol{T})^{-2} \boldsymbol{e})
-(\boldsymbol{\pi} (-\boldsymbol{T})^{-1} \boldsymbol{e})^2
$$

This formula can be reach in phasty using the generic functions `r mean()` and `r var()` with a `r cont_phase_type` object. To get any moment of a `r cont_phase_type` object you can use the formula ... 

Let's take the same example as before to see how to use the different functions:

```{r}
cat('Mean: ',mean(ph),'\n')
cat('Variance: ',var(ph),'\n \n')

cat('Summary: \n-------------')
summary(ph)
cat('-------------')
```

The probability density function (pdf) of a continuous phase-type distribution is defined by equation 3.1.7 of Bladt and Nieslen (2017):

$$
f(u) = \boldsymbol{\pi}e^{\boldsymbol{T}u}\boldsymbol{t}
$$
where $\boldsymbol{t} = -\boldsymbol{T}\boldsymbol{e}$ is the exit rate of the subintensity matrix (the vector of transition from state $i$ to the absorbing state). from there we can get the cdf 

$$ 
F(u) = 1-\boldsymbol{\pi}e^{\boldsymbol{T}u}\boldsymbol{e}
$$


```{r}
x <- seq(0, 10, 0.1)
y <- dphtype(x, ph)
plot(x, y, xlab = 'time before absorbing state', ylab = 'density probability')

y <- pphtype(x, ph)
plot(x, y, xlab = 'time before absorbing state', ylab = 'cumulated density probability')

y <- seq(0, 0.99, 0.01)
x <- qphtype(y, ph)
plot(x, y, xlab = 'time before absorbing state', ylab = 'quantile')

cat('10 random samples: \n \n', rphtype(5, ph), '\n', rphtype(5, ph))
```


It is possible to give to each transient state a weight by a reward 
transformation, to do so we will use a reward vector of size $p$

```{r}
r = c(1,0,4)

Y = reward_phase_type(phase_type = X, reward = r)
print(Y)
```
## The discrete univariate phase-type

```{r}
subintensity_matrix <- matrix(c(0.4, 0, 0,
                              0.24, 0.4, 0,
                              0.12, 0.2, 0.5), ncol = 3)
initial_probabilities <- c(0.9, 0.1, 0)
dph <- phase_type(subintensity_matrix, initial_probabilities)
print(dph)

```

```{r}
x <- seq(0, 10, 1)
y <- dphtype(x, dph)
barplot(y, xlab = 'time before absorbing state', ylab = 'density probability', 
        ylim = c(0, 1))

y <- pphtype(x, dph)
barplot(y, xlab = 'time before absorbing state', ylab = 'cumulated density probability', ylim = c(0, 1))

y <- seq(0, 0.99, 0.01)
x <- qphtype(y, dph)
plot(x, y, xlab = 'time before absorbing state', ylab = 'quantile')

cat('10 random samples: \n \n', rphtype(5, dph), '\n', rphtype(5, dph))
```


# The multivariate distribution
## The continuous multivariate


## The discrete multivariate


# The discrete phase-type distribution


